# YNAB Organizer - Plan

*Updated: 2025-12-12*

## What This Tool Does

A CLI to help Kevin manage YNAB budgets across Personal, Joint, and HOA accounts:

1. **Cross-budget reconciliation** - Mirror splits between Personal ↔ Joint when making transfers
2. **Smart categorization** - Use external data (Gmail, Amazon) to identify generic transactions
3. **Category documentation** - Notion integration for persistent notes (human + agent)

---

## Safety & Rollback

**YNAB has limited undo:**
- Cmd-Z works for recent actions in current session
- **No point-in-time restore** - can't revert to a specific date
- Fresh Start archives old budget but removes transaction history

**Our approach (Hybrid Backup):**

| Layer | What | Where |
|-------|------|-------|
| Per-change snapshots | Save original transaction before modifying | `data/backups/{date}-{txn_id}.json` |
| Weekly full backup | Export entire budget | Neon `ynab_backup` database |
| Operation changelog | Log every CLI write operation | `data/changelog.json` |
| Claude permissions | Force confirmation for YNAB writes | `~/.claude/settings.json` |

**Restore capability:**
- Single transaction: Read from JSON snapshot, re-apply via API
- Full rollback: Query Neon for historical state, bulk restore

Sources: [YNAB Undo/Redo](https://support.ynab.com/en_us/how-to-fix-mistakes-with-undo-and-redo-HJzO5CfA9), [Can I Recover?](https://support.ynab.com/en_us/can-i-revert-or-recover-my-plan-ry5zD7GQ1e)

---

## Phase 1: Foundation

### 1A: Basic CLI ✅
- CLI with `budgets`, `categories`, `uncategorized` commands
- YNAB API integration working
- 5 years of historical data available (11,071 transactions, 91% categorized)

### 1B: Integration Setup (TODAY)
**Goal:** Set up all external connections so future phases can use them

| Integration | Purpose | Status |
|-------------|---------|--------|
| Notion MCP | Category notes, agent memory | ⬜ Not set up |
| Neon backup DB | Full budget backups | ⬜ Not set up |
| Gmail API | Apple receipt matching | ⬜ Not set up |
| Playwright (project) | Amazon order scraping | ⬜ Not set up |
| Claude permissions | Force confirmation on YNAB writes | ⬜ Not set up |

**Setup steps:**

1. **Notion MCP** (global - other projects can use too)
   - Create integration at notion.so/my-integrations
   - Share Personal + Joint budget databases
   - `claude mcp add notion -e NOTION_API_KEY=<token>`
   - Test reading categories

2. **Neon backup database**
   - Create `ynab_backup` database in Neon
   - Schema: transactions, categories, snapshots tables
   - Test connection

3. **Gmail API** (for Apple receipts)
   - Create Google Cloud project
   - Enable Gmail API
   - Create OAuth credentials
   - Store credentials for later use

4. **Project Playwright MCP**
   - Add project-specific Playwright instance
   - Configure for Amazon scraping later

5. **Claude permissions**
   - Add to `~/.claude/settings.json`:
     - Require confirmation for YNAB transaction updates
     - Require confirmation for YNAB deletes

6. **Project structure**
   - Create `claude-plans/` folder, archive this plan
   - Create `guides/` folder with YNAB + tax docs
   - Create `data/backups/` folder

---

## Reference: Budgets & API

### Kevin's Budgets
| Budget | ID | CLI shorthand |
|--------|----|----|
| Kevin's Personal | `09155b46-e44b-48bd-9ff9-8b7d6126ae01` | `personal` |
| K&R Joint | `dd730b46-3428-46e7-a132-50d2d94d8e99` | `joint` |
| 2512 6th HOA | `f09ffdc3-cfb1-4ba7-aa5a-b03f5b0553d3` | `hoa` |

### YNAB API Constraints
| What | Limitation | Workaround |
|------|------------|------------|
| Split transactions | Can CREATE, cannot UPDATE existing | Delete + recreate |
| Rate limit | 200 requests/hour | Cache, batch operations |
| Uncategorized | `category_name === 'Uncategorized'` not `category_id: null` | Filter by name |

---

## Phase 2: Reconciliation

**Problem:** Kevin manually mirrors splits between Personal and Joint when making transfers.

### How It Works Today

```
1. Transaction hits Personal (e.g., Amazon $100)
   Kevin splits: $60 Groceries, $40 "Darn it- shoulda split"

2. Kevin transfers $1,500 to Joint

3. Kevin manually splits the Joint-side transfer:
   - $1,460 → Kevin's Contribution
   - $40 → "Payout - Somebody paid with personal"
```

### What We Automate

The tool reads accumulated "Darn it" items and generates the split for the Joint-side transfer.

### Categories Involved

| Budget | Category | Meaning |
|--------|----------|---------|
| Personal | "Darn it- shoulda split account" | Joint owes Kevin |
| Joint | "Payout - Somebody paid with personal" | Reimbursement (mirrors "Darn it") |
| Joint | "Pay in - Wrong account" | Kevin owes Joint (reverse) |

### Commands

```bash
ynab reconcile                    # Show pending items
ynab reconcile --suggest $1500    # Suggest split for transfer
ynab reconcile --apply            # Apply split (with confirmation)
```

### Implementation Tasks

- [ ] Fetch "Darn it" transactions from Personal
- [ ] Fetch "Pay in - Wrong account" from Joint
- [ ] Calculate net and show itemized list
- [ ] Generate split suggestion with memo text
- [ ] Apply split to Joint transfer (delete + recreate if needed)
- [ ] Track reconciliation history in `data/reconciled.json`

### Open Question

After reconciliation, how to mark "Darn it" items as processed?
- Option A: Add memo note "Reconciled 2024-12-15"
- Option B: Track dates locally in `data/reconciled.json`
- Option C: Use YNAB flag colors

---

## Phase 3: Category Documentation (Notion)

**Problem:** Kevin has category notes in Notion but struggles to keep them updated. This context helps both humans and future Claude sessions.

### Architecture

```
NOTION (source of truth)
├── Personal Budget Database
│   └── Categories with notes + agent tips
├── Joint Budget Database
│   └── Categories with notes + agent tips
        │
        ▼ (Notion MCP)
YNAB ORGANIZER CLI
        │
        ▼ (YNAB API)
YNAB BUDGETS
```

### What Notion Stores

| Field | Who Writes | Purpose |
|-------|------------|---------|
| Category Name | Sync from YNAB | Match YNAB categories |
| YNAB Category ID | Sync from YNAB | Link for API calls |
| Notes | Kevin & Roston | What goes here, tips |
| Agent Notes | Claude sessions | Patterns learned across sessions |
| Current Amount | Kevin | For contribution categories |

### YNAB Memo Sync

Some short tips could sync to YNAB's memo field (visible in mobile app), but Notion remains the full source.

### Commands

```bash
ynab sync-categories          # Compare YNAB ↔ Notion
ynab categories --with-notes  # Show with Notion context
```

### Setup

1. Create integration at notion.so/my-integrations
2. Share Personal + Joint budget databases
3. `claude mcp add notion -e NOTION_API_KEY=<token>`

---

## Phase 4: Smart Categorization

**Problem:** Generic payees (Apple, Amazon) map to many categories. Need external data to identify what was actually purchased.

### Evidence from Kevin's Data
- **Apple (445 tx)**: 15+ categories, memos empty
- **Amazon (2,742 tx)**: 846 in "Darn it" (couldn't identify items)

### Data Sources

| Source | What It Provides | How |
|--------|------------------|-----|
| YNAB History | Past categorizations | Already have |
| Notion | Category tips | Phase 3 |
| Gmail | Apple receipt details | Gmail API |
| Amazon | Order item names | Playwright |

### Suggestion Logic

```
For "Amazon" transaction, $47.23:

1. EXACT MATCH: Same payee + amount before? → 95% confidence
2. SUBSCRIPTION: Recurring monthly? → 90% confidence
3. EXTERNAL DATA: Amazon order matched? → Use item name
4. NOTION TIP: Category notes mention payee? → Follow tips
5. FALLBACK: Show distribution (40% House, 30% Gifts...)
```

### Commands

```bash
ynab analyze              # Build pattern database from history
ynab categorize personal  # Interactive with suggestions
ynab apple-sync           # Match Apple receipts
ynab amazon-sync          # Match Amazon orders
```

---

## Phase 5: External Data Sources

### Apple Receipts (Gmail API)

| Step | What |
|------|------|
| 1 | Search Gmail: `from:apple.com subject:receipt` |
| 2 | Extract: date, amount, app/subscription name |
| 3 | Match to YNAB by date + amount (±2 days) |
| 4 | Update memo with app name, suggest category |

**Setup:** Google Cloud project + OAuth credentials

### Amazon Orders (Playwright)

| Step | What |
|------|------|
| 1 | Navigate to Amazon order history |
| 2 | Extract: date, total, individual items + prices |
| 3 | Match to YNAB by date + amount |
| 4 | Suggest category OR split (multi-item orders) |

**Setup:** Project-specific Playwright MCP, manual login for 2FA

---

## Implementation Sessions

### Session 1: Phase 1B - Integration Setup (TODAY)
See Phase 1B above for full details. Summary:
- [ ] Notion MCP setup + test
- [ ] Neon backup DB setup
- [ ] Gmail API credentials (for later)
- [ ] Project Playwright MCP
- [ ] Claude permissions
- [ ] Project folders + guides

### Session 2: Reconciliation
- [ ] `ynab reconcile` command (show pending, suggest splits)
- [ ] Test with real "Darn it" transactions
- [ ] Apply split functionality

### Session 3: Pattern Analysis
- [ ] `ynab analyze` command (scan history, build patterns)
- [ ] Subscription detection (recurring amounts)
- [ ] Payee → category distribution

### Session 4: Smart Categorization
- [ ] `ynab categorize` command (interactive with suggestions)
- [ ] Pull Notion context for tips
- [ ] Batch review before applying

### Session 5: Apple Integration
- [ ] Set up Gmail API (Google Cloud project)
- [ ] `ynab apple-sync` command
- [ ] Match receipts to transactions

### Session 6: Amazon Integration
- [ ] Set up project Playwright MCP
- [ ] `ynab amazon-sync` command
- [ ] Handle multi-item order splits

### Session 7: Tax Tracking
- [ ] `ynab tax-flag` and `ynab tax-list` commands
- [ ] `ynab tax-export` with CSV output
- [ ] Receipt linking (if time)

---

## File Structure

```
ynab-organizer/
├── src/
│   ├── api/
│   │   └── client.ts           # YNAB API (exists)
│   ├── commands/
│   │   ├── list.ts             # budgets, categories (exists)
│   │   ├── reconcile.ts        # Cross-budget reconciliation
│   │   ├── analyze.ts          # Pattern analysis
│   │   ├── categorize.ts       # Smart categorization
│   │   ├── apple-sync.ts       # Apple receipt matching
│   │   └── amazon-sync.ts      # Amazon order matching
│   ├── services/
│   │   ├── notion.ts           # Notion MCP wrapper
│   │   ├── gmail.ts            # Gmail API
│   │   ├── amazon-scraper.ts   # Playwright scraping
│   │   └── patterns.ts         # Pattern/suggestion engine
│   └── utils/
│       └── format.ts           # Helpers (exists)
├── data/
│   ├── patterns.json           # Learned patterns
│   ├── reconciled.json         # Reconciliation history
│   ├── apple-receipts.json     # Cached receipts
│   └── amazon-orders.json      # Cached orders
└── CLAUDE.md                   # Project instructions
```

---

## Phase 6: Tax Tracking (LLC)

**Problem:** Kevin is working as an LLC and needs to flag business expenses for tax filing.

### What CPA Needs (Texas Single-Member LLC)

| Document | Purpose |
|----------|---------|
| 1099-NECs | Income from clients ($600+) |
| Business expenses with receipts | Deductions for Schedule C |
| Quarterly payment records | If estimated payments made |
| Mileage log | Vehicle deduction |
| Home office calculation | If applicable |

**Texas-specific:** No state income tax. If revenue < $2.47M, no franchise tax (just file Public Information Report).

Sources: [IRS Contractor Forms](https://www.irs.gov/businesses/small-businesses-self-employed/forms-and-associated-taxes-for-independent-contractors), [Texas Franchise Tax](https://comptroller.texas.gov/taxes/franchise/ntd-rpt-updates-2024.php)

### Implementation

**Flag transactions:**
- Add "tax" flag to business expenses in YNAB (use flag color or memo tag)
- Or track in Notion with "Tax Deductible" checkbox

**Export command:**
```bash
ynab tax-export 2024              # Export all flagged transactions for tax year
ynab tax-export 2024 --receipts   # Include linked receipt files
```

**Export format:**
- CSV with: Date, Payee, Amount, Category, Memo, Receipt (if any)
- Summary by category (for Schedule C line items)
- Quarterly breakdown (for estimated payment reconciliation)

### Commands

```bash
ynab tax-flag <transaction>       # Flag a transaction for tax
ynab tax-list                     # Show all flagged transactions
ynab tax-export <year>            # Export for CPA
```

---

## All Commands

```bash
# Existing (Phase 1)
ynab budgets
ynab categories <budget>
ynab uncategorized <budget>

# Reconciliation (Phase 2)
ynab reconcile
ynab reconcile --suggest $X
ynab reconcile --apply

# Notion (Phase 3)
ynab sync-categories
ynab categories --with-notes

# Categorization (Phase 4)
ynab analyze
ynab categorize <budget>

# External Data (Phase 5)
ynab apple-sync
ynab amazon-sync

# Tax Tracking (Phase 6)
ynab tax-flag <transaction>
ynab tax-list
ynab tax-export <year>
```
